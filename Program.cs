using CursoAsp.DdContext;
using CursoAsp.Extensions;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.OpenApi.Models;


//DbContext = pasta que gerencia o controle ao bando de dados 

//EndPointFilters = Esta os filtros onde por exemplo no caso de excluir ou alterar algum item do banco de dados ele proteger e não deixar 

//EndPointHandlers = É onde esta os metodos de Get,Put,Del e Create

//Entities = Contém as classes de entidade que representam as tabelas do banco de dados

//Migrations = Pasta criada pelo EF para a criação de tabelas no sqlite

// Models = Contém as classes de DTOs (Data Transfer Objects) que são usados para definir como os dados são expostos ou recebidos pela API, sem expor
// diretamente as entidades do banco de dados.

//Profiles = Contém as configurações de mapeamento do AutoMapper

//Extensions = onde fica armazenado onde faz as chamadas dos metodos do EndPointHandlers

var builder = WebApplication.CreateBuilder(args);
//criação de uma variavel para armazenar as configuraçoes da webAplication

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(options =>
{
    options.AddSecurityDefinition("TokenAuthRango",
        //definição do nome das configuraçoes
        new()
        {
            Name = "Authorization",
            Description = "Token baseado em Autenticação e Autorização",
            Type = SecuritySchemeType.Http,
            Scheme = "Bearer",
            In = ParameterLocation.Header
        }
        );
    options.AddSecurityRequirement(new()
        {
        //criando uma chave 
            {
            new()
            //adicionando um elemento
            {
                Reference = new OpenApiReference {
                Type = ReferenceType.SecurityScheme,
                Id = "TokenAuthRango"
                }
            },
            new List<string>()
            //adicionando um elemento
            }
        });
});
//configurando o swagger(vem padrão )
builder.Services.AddDbContext<RangoDbContext>(
    o => o.UseSqlite(builder.Configuration["ConnectionStrings:RangoDbStr"])
    );
//criando uma conexão para o banco de dados

builder.Services.AddIdentityApiEndpoints<IdentityUser>()
                .AddEntityFrameworkStores<RangoDbContext>(); 

builder.Services.AddAuthorizationBuilder()
                .AddPolicy("RequiredAdminFromBrazil", policy =>
                {
                    policy
                          .RequireRole("admin")
                          //ROLE É PARA ATRIBUIR O PAPEL 
                          .RequireClaim("country", "Brazil");
                          //CLAIM SERVE PARA ATRIBUIR A LOCALIZAÇÃO 
                });//adicionando politica 


builder.Services.AddAuthentication().AddJwtBearer();
builder.Services.AddAuthorization();
//adicionando configuraçoes de segurança dentro da api, o codigo se encontra no appsettings.json

builder.Services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());
//PEGA OS ASSEMBLY DO DOMINIO ATUAL, PESQUISA QUEM HERDA DE PROFILES E ATRIBUI PARA O PROGRAM 

builder.Services.AddProblemDetails();
// configura para poder usar o UseExceptionHandler
var app = builder.Build();

app.RegisterRangosEndpoints();
app.registerIngredientesEndpoints();

if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler();
    // novo modo de mostrar um erro sem aparecer as tecnologias que esta sendo usada 

    //MODO ALTERNATIVO
    /*
    app.UseExceptionHandler(configureApplicationBuilder =>
    {
        configureApplicationBuilder.Run(
            async context =>
            {
                context.Response.StatusCode = (int)HttpStatusCode.InternalServerError;
                context.Response.ContentType = "text/html";
                await context.Response.WriteAsync("Não foi possivel achar");
            });//essa função vai pegar o status code, 2° vai retornar um text/html para o header, 3° vai enviar uma mensagem no body 
    });*/
    //criar uma mensagem personalizada para o ambiente de produção quando houver um erro
}


app.UseAuthentication();
app.UseAuthorization();
//Faz funcionar os filtros de segurança configurado lá em cima
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}//no caso de estar no ambiente de desenvolvimento ira aparecer o swagger

app.UseHttpsRedirection();

app.Run();